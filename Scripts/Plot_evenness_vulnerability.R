# Evenness vs Fmsy
# Robinson et al 2021
# 3/14/21

library (tidyverse)
library (vegan) # for shannon diversity/evenness
library (rfishbase)

# does FFmsy change in free data; can I get to Fmsy? I think maybe with complex math from Costello et al. SI. ffmsy is constant for each species. 
ds_spp <- readRDS("Data/Free_etal_2020_country_level_outcomes_time_series_for_julia.Rds")

peru_tmp <- ds_spp %>% filter (country == "Peru", rcp == "RCP26", scenario == "No Adaptation", year %in% c(2012:2020, 2090:2100), catch_mt > 0) %>%
  select (rcp, scenario, country, species, year, msy_mt, biomass_mt, catch_mt, bbmsy, ffmsy)

# Robinson et al used Cheung's fishing vulnerability index, which is in fishbase

# "baseline" catch data, arbitrarily picking. mean of 2012-2020 catch for a sense of catch proportions
ds_baseline <- ds_spp %>% 
  filter (year %in% c(2012:2020), catch_mt > 0, rcp == "RCP26", scenario == "No Adaptation") %>%
  group_by (country, rcp, scenario, species) %>%
  summarise (catch_mt = mean (catch_mt, na.rm = TRUE))

# plot histogram of catch for each species---
# anchovy is a huge outlier for chile and peru
ds_baseline %>%
  ggplot (aes (x = catch_mt)) +
  geom_histogram(bins = 100) +
  #geom_text (aes (label = species, y = 50)) +
  facet_wrap (~country, scales = "free") +
  theme_bw() 

# nutrient data for each species
ds_nutr <- readRDS("Data/ds_spp_nutr_content_FishNutrientsGENuS_childRDA.Rds") %>%
  # truncate columns
  select (species, nutrient, amount, perc_rda) %>%
  distinct()

# calculate overall micronutrient density, from maire 2021
ds_nutr_density <- ds_nutr %>%
  group_by (species) %>%
  summarise (micronutrient_density = sum(perc_rda)) %>%
  filter (!is.na (micronutrient_density))


# get vulnerability index from FishBase

# colnames(fb_tbl("estimate")) # this has nutrient data??!?
# colnames (fb_tbl("species")) # this has vulnerability

fish_vuln <- fb_tbl("species") %>%
  mutate(species = paste(Genus, Species)) %>%
  filter(species %in% ds_baseline$species) %>% 
  select(species, Vulnerability)

# calculate catch vulnerability and evenness for overall catch ----
ds_vuln_evenness <- ds_baseline %>%
  left_join (fish_vuln, by = "species") %>%
  group_by (country) %>%
  summarise (catch_vuln = weighted.mean (Vulnerability, w = catch_mt, na.rm = TRUE),
             shannon_div = diversity (catch_mt, index = "shannon"),
             richness = n(), 
             evenness = shannon_div / log (richness))

saveRDS(ds_vuln_evenness, file = "Data/ds_country_nutr_vuln_evenness_Robinson.Rds")


# calculate overall nutrient-weighted vuln and evenness ----
ds_vuln_evenness_overall_nutr <- ds_nutr %>%
  filter (!is.na(amount)) %>%
  group_by (species) %>%
  summarise (micronutrient_density = sum(perc_rda)) %>%
  left_join (ds_baseline, by = "species") %>%
  left_join (fish_vuln, by = "species") %>% 
  group_by (country) %>%
  # in maire et al, it's the proportion of catch
  mutate (catch_wt = catch_mt/sum(catch_mt),
          micronutr_wt = catch_wt * micronutrient_density) %>%
  summarise (catch_vuln = weighted.mean (Vulnerability, w = micronutr_wt, na.rm = TRUE),
             shannon_div = diversity (micronutr_wt, index = "shannon"),
             richness = length (unique (species)), 
             evenness = shannon_div / log (richness))

saveRDS(ds_vuln_evenness_overall_nutr, file = "Data/ds_vuln_evenness_overall_nutr_Robinson_Maire_density.Rds")

ds_vuln_evenness_overall_nutr  %>%
  ggplot (aes (x = catch_vuln, y = evenness)) +
  geom_point (aes(col = country)) +
  geom_text (aes (label = country)) +
  geom_point (data = ds_vuln_evenness, aes (x = catch_vuln, y = evenness), col = "black") +
  geom_text (data = ds_vuln_evenness, aes (x = catch_vuln, y = evenness, label = country)) +
  geom_vline (data = ds_vuln_evenness, aes (xintercept = catch_vuln, col = country), lty = 2, alpha = 0.5) +
  theme_bw() +
  labs (x = "Nutrient-weighed fishing vulnerability", y = "Nutrient catch evenness", col = "") +
  ggtitle ("Nutrient-weighted evenness and vulnerability of catch \n sensu Robinson et al. (2022)")


# calculate vuln and evenness for each nutrient ----
# not sure how to do the catch proportion, doing it in a clunky way here
tot_catch_country <- ds_baseline %>%
  group_by (country) %>%
  summarise (tot_cat = sum(catch_mt))

ds_vuln_evenness_each_nutr <- ds_baseline %>%
  left_join (ds_nutr, by = "species") %>%
  left_join (fish_vuln, by = "species") %>% 
  filter (!is.na(amount)) %>%
  #clunky attach to full country catch
  left_join (tot_catch_country, by = "country") %>%
  group_by (country) %>%
  # in maire et al, it's the proportion of catch
  mutate (catch_wt = catch_mt/tot_cat,
          nutr_wt = catch_wt *perc_rda/100) %>%
  group_by (country, nutrient) %>%
  summarise (catch_vuln = weighted.mean (Vulnerability, w = nutr_wt, na.rm = TRUE),
             shannon_div = diversity (nutr_wt, index = "shannon"),
             richness = length (unique (species)), 
             evenness = shannon_div / log (richness))

saveRDS(ds_vuln_evenness_each_nutr, file = "Data/ds_vuln_evenness_each_nutr_Robinson_Maire_density.Rds")

ds_vuln_evenness_each_nutr %>%
  ggplot (aes (x = catch_vuln, y = evenness)) +
  geom_point (aes(col = country)) +
  geom_text (aes (label = nutrient, col = country)) +
  geom_point (data = ds_vuln_evenness, aes (x = catch_vuln, y = evenness), col = "black") +
  geom_text (data = ds_vuln_evenness, aes (x = catch_vuln, y = evenness, label = country)) +
  geom_vline (data = ds_vuln_evenness, aes (xintercept = catch_vuln, col = country), lty = 2, alpha = 0.5) +
  theme_bw() +
  labs (x = "Nutrient-weighed fishing vulnerability", y = "Nutrient catch evenness", col = "") +
  ggtitle ("Nutrient-weighted evenness and vulnerability of catch \n sensu Robinson et al. (2022)")


# calculate evenness and vulnerability for overall nutrient density----

## remove anchovy for chile and peru ----

ds_vuln_evenness_noanchov <- ds_baseline %>%
  filter (species != "Engraulis ringens", country %in% c ("Chile", "Peru")) %>%
  left_join (fish_vuln, by = "species") %>%
  group_by (country) %>%
  summarise (catch_vuln = weighted.mean (Vulnerability, w = catch_mt, na.rm = TRUE),
             shannon_div = diversity (catch_mt, index = "shannon"),
             richness = n(), 
             evenness = shannon_div / log (richness))

#saveRDS(ds_vuln_evenness, file = "Data/ds_country_nutr_vuln_evenness_Robinson.Rds")

tot_catch_country_noanchov <- ds_baseline %>%
  filter (species != "Engraulis ringens", country %in% c ("Chile", "Peru")) %>%
  group_by (country) %>%
  summarise (tot_cat = sum(catch_mt))

ds_vuln_evenness_each_nutr_noanchov <- ds_baseline %>%
  filter (species != "Engraulis ringens", country %in% c ("Chile", "Peru")) %>%
  left_join (ds_nutr, by = "species") %>%
  left_join (fish_vuln, by = "species") %>% 
  filter (!is.na(amount)) %>%
  #clunky attach to full country catch
  left_join (tot_catch_country_noanchov, by = "country") %>%
  group_by (country) %>%
  # in maire et al, it's the proportion of catch
  mutate (catch_wt = catch_mt/tot_cat,
          nutr_wt = catch_wt *perc_rda/100) %>%
  group_by (country, nutrient) %>%
  summarise (catch_vuln = weighted.mean (Vulnerability, w = nutr_wt, na.rm = TRUE),
             shannon_div = diversity (nutr_wt, index = "shannon"),
             richness = length (unique (species)), 
             evenness = shannon_div / log (richness))

#saveRDS(ds_vuln_evenness_each_nutr, file = "Data/ds_vuln_evenness_each_nutr_Robinson_Maire_density.Rds")

ds_vuln_evenness_each_nutr_noanchov  %>%
  ggplot (aes (x = catch_vuln, y = evenness)) +
  geom_point (aes(col = country)) +
  geom_text (aes (label = nutrient, col = country)) +
  geom_point (data = ds_vuln_evenness_noanchov, aes (x = catch_vuln, y = evenness), col = "black") +
  geom_text (data = ds_vuln_evenness_noanchov, aes (x = catch_vuln, y = evenness, label = country)) +
  geom_vline (data = ds_vuln_evenness_noanchov, aes (xintercept = catch_vuln, col = country), lty = 2, alpha = 0.5) +
  theme_bw() +
  labs (x = "Nutrient-weighed fishing vulnerability", y = "Nutrient catch evenness", col = "") +
  ggtitle ("Nutrient-weighted evenness and vulnerability of catch, Anchovy removed \n sensu Robinson et al. (2022)")


ds_vuln_evenness_chl_per_no_anchov <- ds_baseline %>%
  left_join (fish_vuln, by = "species") %>%
  filter (country %in% c("Chile", "Peru"), species != "Engraulis ringens") %>%
  group_by (country) %>%
  summarise (catch_vuln = weighted.mean (Vulnerability, w = catch_mt, na.rm = TRUE),
             shannon_div = diversity (catch_mt, index = "shannon"),
             richness = n(), 
             evenness = shannon_div / log (richness))

#saveRDS(ds_vuln_evenness, file = "Data/ds_country_nutr_vuln_evenness_Robinson.Rds")

# calculate vuln and evenness for nutrient catch ----
ds_nutr_vuln_evenness_chl_per_no_anchov <- ds_baseline %>%
  filter (country %in% c("Chile", "Peru"), species != "Engraulis ringens") %>%
  left_join (ds_nutr, by = "species") %>%
  left_join (fish_vuln, by = "species") %>% 
  filter (!is.na(amount)) %>%
  mutate (nutr_catch = catch_mt * amount) %>%
  group_by (country, nutrient) %>%
  summarise (catch_vuln = weighted.mean (Vulnerability, w = nutr_catch, na.rm = TRUE),
             shannon_div = diversity (nutr_catch, index = "shannon"),
             richness = length (unique (species)), 
             evenness = shannon_div / log (richness))

#saveRDS(ds_nutr_vuln_evenness, file = "Data/ds_spp_nutr_vuln_evenness_Robinson.Rds")
ds_nutr_vuln_evenness_chl_per_no_anchov %>%
  ggplot (aes (x = catch_vuln, y = evenness)) +
  geom_point (aes(col = country)) +
  geom_text (aes (label = nutrient, col = country)) +
  geom_point (data = ds_vuln_evenness_chl_per_no_anchov, aes (x = catch_vuln, y = evenness), col = "black") +
  geom_text (data = ds_vuln_evenness_chl_per_no_anchov, aes (x = catch_vuln, y = evenness, label = country)) +
  geom_vline (data = ds_vuln_evenness_chl_per_no_anchov, aes (xintercept = catch_vuln, col = country), lty = 2, alpha = 0.5) +
  theme_bw() +
  labs (x = "Nutrient-weighed fishing vulnerability", y = "Nutrient catch evenness", col = "") +
  ggtitle ("Nutrient-weighted evenness and vulnerability of catch \n sensu Robinson et al. (2022)")




# can I also plot the density plot...? ----
ds_nutr_vuln_spp <- ds_baseline %>%
  left_join (ds_nutr, by = "species") %>%
  left_join (fish_vuln, by = "species") %>% 
  filter (!is.na(amount)) %>%
  mutate (nutr_catch = catch_mt * amount)
  

ggplot (ds_nutr_vuln_spp) +
  geom_point (aes (y = log(nutr_catch), x =Vulnerability, col =nutrient)) +
  facet_wrap (~country, scales = "free")

ggplot (ds_nutr_vuln_spp, aes (y = amount, x =Vulnerability, col =nutrient)) +
  geom_point() +
  #geom_smooth() +
  facet_wrap (~country, scales = "free") +
  theme_bw()

# need to scale nutrients?
ds_nutr_scaled <- ds_nutr %>%
  distinct() %>%
  filter (!is.na(amount)) %>%
  pivot_wider (names_from = nutrient, 
               values_from = amount) %>%
  mutate (across (Selenium:Vitamin_A, scale)) %>%
# not sure if it's actually renaming the columns
  #rename_with (~gsub("[,1]", "", .x))
  pivot_longer (-species, 
                names_to = "nutrient", 
                values_to = "amount")

ds_nutr_vuln_spp_scaled <- ds_baseline %>%
  left_join (ds_nutr_scaled, by = "species") %>%
  left_join (fish_vuln, by = "species") %>% 
  filter (!is.na(amount)) %>%
  mutate (nutr_catch = catch_mt * amount)
  
ggplot (ds_nutr_vuln_spp_scaled, aes (y = amount, x =Vulnerability, col =nutrient)) +
  geom_point() +
  #geom_smooth() +
  facet_wrap (~country, scales = "free") +
  theme_bw()


# plot evenness and catch with scalars? can't bc can't have negative for diversity
ds_nutr_vuln_evenness_scaled <- ds_baseline %>%
  left_join (ds_nutr_scaled, by = "species") %>%
  left_join (fish_vuln, by = "species") %>% 
  filter (!is.na(amount)) %>%
  mutate (nutr_catch = catch_mt * amount) %>%
  group_by (country, nutrient) %>%
  summarise (catch_vuln = weighted.mean (Vulnerability, w = nutr_catch, na.rm = TRUE),
             shannon_div = diversity (nutr_catch, index = "shannon"),
             richness = length (unique (species)), 
             evenness = shannon_div / log (richness))



ds_nutr_vuln_evenness %>%
  ggplot (aes (x = catch_vuln, y = evenness)) +
  geom_point (aes(col = country)) +
  geom_text (aes (label = nutrient, col = country)) +
  geom_point (data = ds_vuln_evenness, aes (x = catch_vuln, y = evenness), col = "black") +
  geom_text (data = ds_vuln_evenness, aes (x = catch_vuln, y = evenness, label = country)) +
  theme_bw() +
  labs (x = "Nutrient-weighed fishing vulnerability", y = "Nutrient catch evenness", col = "")


